$schema: https://json-schema.org/draft/2020-12/schema
$schemaVersion: 1.0.0
title: Goneat Dependencies Policy

description: Schema for dependency policy configuration (licenses, cooling, sbom, vulnerabilities)
type: object
properties:
  $schema:
    type: string
    description: JSON Schema reference for this policy file
    format: uri
    examples:
      - https://schemas.goneat.dev/dependencies-policy/v1.0.0
  version:
    type: string
    description: Policy file version
    enum: [v1]

  licenses:
    type: object
    description: License compliance policy
    properties:
      forbidden:
        type: array
        description: Forbidden licenses (policy violation)
        items:
          type: string
      allowed:
        type: array
        description: Allowed licenses (stricter approach)
        items:
          type: string
      allow:
        type: array
        description: Allowed licenses (legacy alias for allowed)
        items:
          type: string
      exceptions:
        type: array
        description: Optional per-package license exceptions
        items:
          oneOf:
            - type: object
              properties:
                package:
                  type: string
                license:
                  type: string
                reason:
                  type: string
                approved_by:
                  type: string
                approved_date:
                  type: string
                ticket:
                  type: string
              required: [package, license, reason]
              additionalProperties: false
            - type: object
              properties:
                name:
                  type: string
                licenses:
                  type: array
                  items:
                    type: string
                reason:
                  type: string
                approved_by:
                  type: string
                approved_date:
                  type: string
                ticket:
                  type: string
              required: [name, licenses, reason]
              additionalProperties: false
    additionalProperties: false

  cooling:
    type: object
    description: Supply-chain cooling policy
    properties:
      enabled:
        type: boolean
      min_age_days:
        type: integer
        minimum: 0
        maximum: 3650
      min_downloads:
        type: integer
        minimum: 0
      min_downloads_recent:
        type: integer
        minimum: 0
      alert_only:
        type: boolean
      grace_period_days:
        type: integer
        minimum: 0
        maximum: 365
      exceptions:
        type: array
        items:
          type: object
          properties:
            pattern:
              type: string
            reason:
              type: string
            until:
              type: string
            approved_by:
              type: string
            approved_date:
              type: string
            ticket:
              type: string
          required: [pattern]
          additionalProperties: false
    additionalProperties: false

  sbom:
    type: object
    description: SBOM generation configuration
    properties:
      output_dir:
        type: string
      format:
        type: string
        enum: [cyclonedx-json, spdx-json]
      include_dev_dependencies:
        type: boolean
    additionalProperties: false

  vulnerabilities:
    type: object
    description: Vulnerability scanning policy configuration
    properties:
      enabled:
        type: boolean
      tool:
        type: string
        description: Vulnerability scanner tool name
        enum: [grype, trivy]
      fail_on:
        type: string
        description: Failure threshold for vulnerability findings
        enum: [critical, high, medium, low, any, none]
      ignore_unfixed:
        type: boolean
      allow:
        type: array
        description: Allowed vulnerabilities (suppressed)
        items:
          type: object
          properties:
            id:
              type: string
              description: Vulnerability identifier (CVE/GHSA)
            until:
              type: string
              description: Optional expiry date
            reason:
              type: string
            approved_by:
              type: string
            approved_date:
              type: string
            ticket:
              type: string
          required: [id, reason]
          additionalProperties: false
      remediation_age:
        type: object
        description: Remediation age policy (days a known vulnerability may remain before enforcement)
        properties:
          enabled:
            type: boolean
          max_days:
            type: object
            additionalProperties:
              type: integer
              minimum: 0
        additionalProperties: false
      cooling_days:
        type: object
        description: Compatibility alias for remediation_age (days) by severity
        additionalProperties:
          type: integer
          minimum: 0
      severity_map:
        type: object
        description: Optional CVSS threshold mapping
        properties:
          critical:
            type: number
            minimum: 0
            maximum: 10
          high:
            type: number
            minimum: 0
            maximum: 10
          medium:
            type: number
            minimum: 0
            maximum: 10
          low:
            type: number
            minimum: 0
            maximum: 10
        additionalProperties: false
    additionalProperties: false

  languages:
    type: array
    description: Optional language detection overrides
    items:
      type: object
      properties:
        language:
          type: string
        paths:
          type: array
          items:
            type: string
      required: [language]
      additionalProperties: false

  python:
    type: object
    description: Python-specific settings
    additionalProperties: true

  node:
    type: object
    description: Node/Bun-specific settings
    additionalProperties: true

  policy_engine:
    type: object
    description: Policy engine configuration
    properties:
      type:
        type: string
        enum: [embedded, server]
      remote:
        type: object
        properties:
          url:
            type: string
          auth:
            type: object
            properties:
              type:
                type: string
              token_env:
                type: string
            additionalProperties: false
        additionalProperties: false
      rego_files:
        type: array
        items:
          type: string
    additionalProperties: false

additionalProperties: false
required: [version]
examples:
  - version: v1
    licenses:
      forbidden: [GPL-3.0, AGPL-3.0]
      allowed: [MIT, Apache-2.0]
    cooling:
      enabled: true
      min_age_days: 7
      min_downloads: 100
      min_downloads_recent: 10
      alert_only: false
      grace_period_days: 3
      exceptions:
        - pattern: "github.com/fulmenhq/*"
          reason: "Internal packages are pre-vetted"
          approved_by: "@3leapsdave"
    sbom:
      output_dir: sbom
      format: cyclonedx-json
    vulnerabilities:
      enabled: true
      tool: grype
      fail_on: none
      ignore_unfixed: false
      remediation_age:
        enabled: true
        max_days:
          critical: 7
          high: 30
          medium: 90
      allow:
        - id: CVE-2024-12345
          until: 2026-06-30
          reason: "Vendor patch pending"
          approved_by: "@security"
    policy_engine:
      type: embedded
