# v0.3.13 Release Notes

**Release Date**: 2025-12-04

## Overview

v0.3.13 introduces dynamic yamlfmt indent detection for enterprise environments, fixes CI tool detection issues, and updates the Crucible SSOT to v0.2.22.

## Highlights

### Dynamic yamlfmt Indent Detection

The `goneat doctor tools init` command now automatically reads your `.yamlfmt` configuration to determine the correct indentation for generated files.

**Before v0.3.13**: Hardcoded 2-space indentation regardless of project settings.

**After v0.3.13**: Reads `.yamlfmt` and uses the configured indent value.

```go
// detectYamlfmtIndent walks up the directory tree to find .yamlfmt
// and extracts the formatter.indent value
func detectYamlfmtIndent() int {
    // Security: Only accepts indent values 1-8
    // Falls back to 2 if not found or invalid
}
```

**Security Hardening**:

- Rejects indent values less than 1 or greater than 8
- Protects against malicious/corrupt `.yamlfmt` files
- Integer overflow protection (rejects INT_MAX values)

### CI Tool Detection Fix

Fixed issue where tools installed via brew or bun weren't detected in CI environments after bootstrap:

**Root Cause**: The format command used `exec.LookPath()` which only checks `$PATH`, but brew/bun install tools to shim directories that may not be in PATH yet.

**Fix**: New `findToolPath()` helper that:

1. First checks `$PATH` (standard lookup)
2. Falls back to checking known shim directories (brew, bun, go/bin)

This ensures tools are found immediately after installation, before shell restart.

### Crucible v0.2.22

Updated SSOT consumer to sync from Crucible v0.2.22:

- **Schema Fix**: `goneat-tools-config.schema.yaml` now includes `node` and `python` installer kinds
- Previously, the schema only allowed `["go", "bundled-go", "system"]`
- Now correctly allows `["go", "bundled-go", "system", "node", "python"]`

This resolves schema validation errors for tools like prettier (node) and yamlfmt (python).

## Technical Details

### New Functions

**`detectYamlfmtIndent()`** (`cmd/doctor_tools_init.go`):

```go
func detectYamlfmtIndent() int {
    const (
        defaultIndent = 2
        minIndent     = 1
        maxIndent     = 8
    )
    // Walk up directory tree looking for .yamlfmt
    // Parse formatter.indent value
    // Validate within sane limits
    // Return default if not found or invalid
}
```

**`findToolPath()`** (`cmd/format.go`):

```go
func findToolPath(name string) string {
    // 1. Check PATH via exec.LookPath
    // 2. Check brew shim directory
    // 3. Check bun shim directory
    // 4. Check go/bin directory
    // Return first found, or empty string
}
```

### Test Coverage

New tests added:

- `TestDetectYamlfmtIndent` - 12 test cases including:
  - Valid indent detection (2, 4, 8)
  - Edge cases (0, -1, 100, INT_MAX)
  - Invalid YAML handling
  - Missing file handling
- `TestDetectYamlfmtIndentNoFile` - No `.yamlfmt` present
- `TestDetectYamlfmtIndentWalksUpTree` - Parent directory detection
- `TestDoctorToolsInitUsesYamlfmtIndent` - Integration test

## Migration Guide

### No Action Required

This release is fully backwards compatible. Existing configurations continue to work.

### Optional: Regenerate Tools Config

If your project uses a non-default yamlfmt indent:

```bash
# Regenerate with correct indent
goneat doctor tools init --force

# Verify indent matches your .yamlfmt
head -20 .goneat/tools.yaml
```

### CI Pipeline Updates

Update goneat version in install scripts:

```bash
GONEAT_VERSION="v0.3.13"
```

## Files Changed

| File                                                                              | Change                               |
| --------------------------------------------------------------------------------- | ------------------------------------ |
| `cmd/doctor_tools_init.go`                                                        | Add `detectYamlfmtIndent()` function |
| `cmd/doctor_tools_init_test.go`                                                   | Add indent detection tests           |
| `cmd/format.go`                                                                   | Add `findToolPath()` helper          |
| `internal/doctor/package_managers.go`                                             | Fix brew detection                   |
| `.goneat/ssot-consumer.yaml`                                                      | Update to Crucible v0.2.22           |
| `schemas/crucible-go/tooling/goneat-tools/v1.0.0/goneat-tools-config.schema.yaml` | Add node/python kinds                |

Plus various config, docs, and schema files synced from Crucible v0.2.22.

## See Also

- [CHANGELOG.md](../../CHANGELOG.md) - Full changelog
- [v0.3.12 Release Notes](v0.3.12.md) - Previous release

---

Generated by Arch Eagle ([Claude Code](https://claude.ai/code)) under supervision of @3leapsdave
