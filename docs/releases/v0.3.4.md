# Goneat v0.3.4 — Package Managers & SSOT DX

**Release Date**: 2025-11-08
**Status**: Release

## TL;DR

- **Package Manager Installation**: Tools config v1.1.0 with declarative Homebrew/Scoop installations
- **SSOT Force-Remote**: Explicit remote sync with improved auto-detection DX
- **Schema Versioning**: Provenance schemas v1.1.0 with force-remote tracking
- **Developer Experience**: .local.yaml now signals local dev intent for cleaner workflows

## What's New

### Package Manager Installation Support

Tools configuration schema v1.1.0 introduces structured package manager installation support, enabling declarative configuration for Homebrew and Scoop installations.

**New `install` Field**:

```yaml
version: v1.1.0

tools:
  - name: ripgrep
    description: Fast recursive grep
    kind: infrastructure
    detect_command: rg --version
    install: # New declarative format
      package_manager: brew
      package_name: ripgrep
      tap: homebrew/core # Optional
      binary_name: rg # Optional - if different from package name
      destination: /opt/homebrew/bin # Optional
      flags: # Optional - for complex installations
        - --force
        - --overwrite
```

**Features**:

- **Declarative Configuration**: Structured YAML instead of shell commands
- **Package Manager Support**: Homebrew (macOS/Linux), Scoop (Windows)
- **Custom Taps/Buckets**: Support for third-party package sources
- **Binary Name Mapping**: Handle cases where package name ≠ binary name
- **Installation Destinations**: Specify custom install locations
- **Multiple Flags**: Support complex installation scenarios
- **Schema Validation**: Enforced mutual exclusivity with legacy `install_commands`
- **Better Error Messages**: Clear validation feedback for configuration issues

**Migration Path**:

```yaml
# Old format (v1.0.0)
tools:
  - name: ripgrep
    install_commands:
      - "brew install ripgrep"

# New format (v1.1.0)
tools:
  - name: ripgrep
    install:
      package_manager: brew
      package_name: ripgrep
```

**Breaking Change Note**: `install` and `install_commands` are mutually exclusive (enforced via schema). Choose one approach per tool.

### SSOT Force-Remote Sync

Enable explicit remote syncing even when local directories exist, with improved developer experience through smarter auto-detection.

**New Command Options**:

```bash
# Force remote sync (ignore local auto-detection)
goneat ssot sync --force-remote

# Force remote via environment variable
GONEAT_FORCE_REMOTE_SYNC=1 goneat ssot sync

# Per-source config option
# .goneat/ssot-consumer.yaml:
sources:
  - name: crucible
    repo: fulmenhq/crucible
    ref: v0.2.8
    force_remote: true  # Always use remote
```

**DX Improvement - Auto-Detection Signal**:

The major DX improvement in v0.3.4 is making `.local.yaml` presence signal local development intent:

**Before v0.3.4**:

- Auto-detection always ran if `../crucible` directory existed
- Even without `.local.yaml`, goneat would use local directory
- Needed `--force-remote` flag to test remote sync behavior
- Confusing for production/CI usage

**After v0.3.4**:

- Auto-detection only runs when `.local.yaml` exists
- Absence of `.local.yaml` signals "use production config"
- No need for `--force-remote` in common case
- Clear signal: `.local.yaml` = local dev, no `.local.yaml` = production

**Configuration Precedence**:

1. **Command-line flags** (`--local-path` or `--force-remote`)
2. **Environment variables** (`GONEAT_FORCE_REMOTE_SYNC=1`)
3. **Local override** (`.goneat/ssot-consumer.local.yaml`)
4. **Primary manifest** (`.goneat/ssot-consumer.yaml`)
5. **Auto-detection** (`../<source>`) - **only if `.local.yaml` exists**

**Example: TSFulmen Testing**:

```bash
# Before v0.3.4 - needed flag
cd tsfulmen
rm .goneat/ssot-consumer.local.yaml  # Remove local config
goneat ssot sync --force-remote      # Still needed flag!

# After v0.3.4 - clean workflow
cd tsfulmen
# No .local.yaml? Auto-detection disabled automatically
goneat ssot sync  # Uses production config (remote)
```

**Use Cases**:

- **Local Development**: Create `.local.yaml` pointing to `../crucible` for local testing
- **Production/CI**: Don't create `.local.yaml`, uses remote repos from production config
- **Edge Cases**: Use `--force-remote` when you have `.local.yaml` but want to temporarily test remote behavior

### SSOT Provenance Schemas v1.1.0

Proper schema versioning for force-remote metadata tracking:

**New Schemas**:

- `schemas/crucible-go/content/ssot-provenance/v1.1.0/ssot-provenance.schema.json`
- `schemas/ssot/source-metadata.v1.1.0.json`

**New Fields**:

```json
{
  "sources": [
    {
      "name": "crucible",
      "forced_remote": true, // New: Was force-remote used?
      "forced_by": "flag", // New: How? "flag"|"env"|"config"
      "method": "git_clone",
      "commit": "abc123..."
    }
  ]
}
```

**Schema Versioning**:

- ✅ v1.0.0 schemas preserved unchanged
- ✅ v1.1.0 schemas include force-remote fields
- ✅ All code updated to reference v1.1.0
- ✅ Synced to embedded assets
- ✅ Tests updated and passing

**Audit Trail**: The `forced_remote` and `forced_by` fields enable CI enforcement and audit trails to track whether syncs used remote repos or local paths.

## Installation

```bash
# Go install (recommended)
go install github.com/fulmenhq/goneat@v0.3.4

# Verify installation
goneat version
```

## Upgrade Notes

### For SSOT Users

**Review Auto-Detection Behavior**:

```bash
# Check if you have local overrides
ls -la .goneat/ssot-consumer.local.yaml

# If you DON'T have .local.yaml:
# ✅ No change - production config works as before

# If you DO have .local.yaml:
# ✅ Auto-detection continues working (signals local dev)

# If you have .local.yaml but want to test remote:
goneat ssot sync --force-remote
```

**Migration**: No configuration changes required. The DX improvement is backward compatible:

- **With `.local.yaml`**: Auto-detection works as before (local dev signal)
- **Without `.local.yaml`**: Auto-detection now properly disabled (production signal)

### For Tools Config Users

**Upgrade to v1.1.0 Schema**:

```yaml
# Update schema version
version: v1.1.0 # Was: v1.0.0

# Optionally migrate to declarative install format
tools:
  - name: your-tool
    # Old: install_commands: ["brew install your-tool"]
    # New:
    install:
      package_manager: brew
      package_name: your-tool
```

## Breaking Changes

**None**. All changes are backward compatible:

- **Tools Config**: v1.1.0 is optional, v1.0.0 continues to work
- **SSOT**: Auto-detection improvement is more correct, not breaking
- **Schemas**: v1.0.0 schemas preserved, v1.1.0 is additive

## Documentation

- **SSOT Guide**: Updated `docs/appnotes/lib/ssot.md` with:
  - Force-remote flag documentation
  - Auto-detection behavior section (v0.3.4+)
  - Configuration precedence with `.local.yaml` signal
  - TSFulmen use case example
  - Provenance field reference

## Testing

All tests passing:

```bash
# Schema validation tests
go test ./pkg/tools/... -v
# Provenance tests
go test ./pkg/ssot/... -v -run TestProvenance
# Auto-detection behavior tests
go test ./pkg/ssot/... -v -run TestAutoDetection
```

**Coverage**:

- ✅ Tools config v1.1.0 schema validation
- ✅ Package manager installation fixtures
- ✅ Force-remote flag behavior
- ✅ Auto-detection with/without `.local.yaml`
- ✅ Provenance schema v1.1.0 validation

## Known Issues

None at release time.

## What's Next (v0.3.5+)

Planned enhancements:

- **Tool Installation Execution**: Implement actual package manager installation (currently schema-only)
- **Multi-Language SSOT**: Support for TypeScript/Python SSOT patterns
- **Provenance Validation**: CI gates for enforcing clean provenance

## Links

- **Repository**: https://github.com/fulmenhq/goneat
- **CHANGELOG**: See [CHANGELOG.md](../../CHANGELOG.md) for detailed changes
- **Previous Release**: [v0.3.3](v0.3.3.md) - Cryptographic Release Signing

---
