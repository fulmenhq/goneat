# v0.3.14 Release Notes

**Release Date**: 2025-12-08

## Overview

v0.3.14 introduces **two-path CI validation** - validating both the container approach (LOW friction, recommended for CI) and the package manager approach (HIGHER friction, for platforms without containers). The strategic dependency ordering ensures we don't waste cycles on package manager issues if the container path fails.

## Highlights

### Two-Path CI Validation

goneat now validates **two approaches** for tool availability with explicit dependency ordering:

```
build-test-lint
       ↓ (uploads goneat binary as artifact)
container-probe  ← LOW friction, validates first
       ↓ (only runs if container passes)
bootstrap-probe  ← HIGHER friction, validates second
```

**Why This Matters**:

- Container path is THE recommended approach for CI runners - validate it first
- Don't waste cycles on package manager issues if container fails
- Gives users confidence: "If goneat CI passes, my container-based CI will work"

### Container-Probe (Recommended for CI)

The `container-probe` job downloads the goneat binary and validates it works inside the container:

```yaml
container-probe:
  needs: [build-test-lint]
  container:
    image: ghcr.io/fulmenhq/goneat-tools:latest
  steps:
    - uses: actions/download-artifact@v4
    - run: ./goneat doctor tools --scope foundation
    - run: ./goneat format --check .
```

**Key Insight**: This proves goneat **integration**, not just that tools exist (`--version`).

**Benefits**:

- **Container IS the contract**: Same image everywhere = same behavior
- **Eliminates package manager issues**: No more OpenSSL@3/brew failures
- **Pre-built tools**: prettier, yamlfmt, jq, yq, rg, git, bash ready to use

### Bootstrap-Probe (Package Manager Path)

The `bootstrap-probe` job validates that `goneat doctor tools --install` works on fresh runners:

- Only runs if `container-probe` passes (strategic dependency)
- Important for users who can't use containers
- Future: Could expand to matrix (ubuntu, macos, windows)

### ToolExecutor Package (Phase 1)

New `pkg/tools/executor*.go` package provides infrastructure for tool execution:

```go
// Factory creates executor based on mode
executor := tools.NewExecutor(tools.ModeAuto)

// Check if tool is available
available := executor.IsAvailable("prettier")

// Execute tool
result, err := executor.Execute(ctx, "prettier", args, workDir)
```

**Files Added**:

- `executor.go` - Interface definition and factory
- `executor_local.go` - Local PATH-based execution
- `executor_docker.go` - Docker container execution
- `executor_auto.go` - Smart mode selection based on environment
- `executor_test.go` - Comprehensive test coverage

**Mode Selection Logic**:

- `ModeLocal`: Use local tools from PATH
- `ModeDocker`: Use goneat-tools container
- `ModeAuto`: CI environment → Docker, otherwise → Local

**Note**: This is Phase 1 infrastructure only. Integration into `cmd/format.go` with `--tool-mode` flag planned for v0.3.15.

### Local CI Runner Support

New Makefile targets allow running CI checks locally using the same container:

```bash
# Run format-check job locally
make local-ci-format

# Run all CI jobs
make local-ci-all
```

**Requirements**: Docker must be installed and running.

### golangci-lint v2 Update

Updated golangci-lint installation path for v2:

| Version | Install Command |
|---------|-----------------|
| v1.x | `go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest` |
| v2.x | `go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@latest` |

Minimum version updated from 1.54.0 to 2.0.0.

## Technical Details

### CI Workflow Structure

```yaml
jobs:
  format-check:           # NEW: Container-based format checking
    container: ghcr.io/fulmenhq/goneat-tools:latest
    # Runs prettier, yamlfmt inside container

  build-test-lint:        # SIMPLIFIED: No bootstrap/prettier steps
    # Go build, test, lint only

  install-probe:          # UNCHANGED: Tests tool installation
    # Validates bootstrap works on fresh runners
```

### goneat-tools Container

The container is built from the fulmen-toolbox monorepo and includes:

- **Formatters**: prettier, yamlfmt
- **CLI Tools**: jq, yq, ripgrep (rg)
- **Utilities**: git, bash, common Linux tools

Image: `ghcr.io/fulmenhq/goneat-tools:latest`

### ToolExecutor Interface

```go
type Executor interface {
    // IsAvailable checks if a tool can be executed
    IsAvailable(tool string) bool

    // Execute runs a tool with arguments
    Execute(ctx context.Context, tool string, args []string, workDir string) (*Result, error)

    // Mode returns the executor mode
    Mode() Mode
}
```

## Migration Guide

### No Action Required

This release is fully backwards compatible. Existing configurations and workflows continue to work.

### Optional: Test Local CI

```bash
# Install Docker if not present
# Then test the container-based format check:
make local-ci-format
```

### Optional: Update golangci-lint

```bash
# If you have v1.x installed globally
go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@latest
```

## Files Changed

| File | Change |
|------|--------|
| `.github/workflows/ci.yml` | Add container-based format-check job |
| `Makefile` | Add local-ci-format, local-ci-all targets |
| `VERSION` | Update to v0.3.14 |
| `config/tools/foundation-tools-defaults.yaml` | Update golangci-lint v2 path |
| `pkg/tools/executor.go` | New executor interface |
| `pkg/tools/executor_local.go` | Local executor implementation |
| `pkg/tools/executor_docker.go` | Docker executor implementation |
| `pkg/tools/executor_auto.go` | Auto-selection executor |
| `pkg/tools/executor_test.go` | Executor tests |
| `docs/cicd/local-runner.md` | Local CI runner documentation |

## Future Work (v0.3.15)

- Integrate ToolExecutor into `cmd/format.go`
- Add `--tool-mode` CLI flag (local, docker, auto)
- Add `goneat doctor tools --docker` command

## See Also

- [CHANGELOG.md](../../CHANGELOG.md) - Full changelog
- [v0.3.13 Release Notes](v0.3.13.md) - Previous release

---

Generated by Arch Eagle ([Claude Code](https://claude.ai/code)) under supervision of @3leapsdave
