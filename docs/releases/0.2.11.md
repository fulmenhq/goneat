# Release Notes - goneat v0.2.11

## TL;DR

- **Guardian Approval UX**: Fixed guardian approval browser page to display full command details with arguments
- **CI/CD Quality Gates**: Added embed verification to pre-push validation to prevent asset drift
- **Hook Enhancements**: All guardian-protected hooks now capture and pass command arguments for better visibility

## What's New

### Guardian Approval Command Visibility

Enhanced the guardian approval workflow to provide command transparency:

- **Full Command Display for Direct Usage**: When using `guardian approve` directly (e.g., `goneat guardian approve system ls -- ls -la /tmp`), the approval page shows the complete command with all arguments
- **Pre-push Hook**: Displays remote name and branch being pushed (e.g., `git push origin main`)
- **Git Hook Limitations**: Pre-commit and pre-reset hooks show generic placeholders (e.g., `git commit -m <pending commit message>`) because Git does not pass original command-line arguments to hook scripts
- **Command Details Section**: Collapsible section on approval page displays available command information with proper formatting
- **Best User Experience**: For full command visibility in git operations, wrap commands with `guardian approve` instead of relying on automatic hook triggers

#### Technical Implementation

The fix involved several key changes:

1. **Command Construction in `cmd/guardian.go`**:
   - `runGuardianCheck()`: Now properly constructs full command by combining scope, operation, and arguments
   - `runGuardianApprove()`: Similarly enhanced to build complete command strings
   - Example: `git commit -m "message"` instead of just the arguments

2. **Hook Template Updates**:
   - `pre-commit.sh.tmpl`: Reads commit message from `.git/COMMIT_EDITMSG` and passes as `-- -m "message"`
   - `pre-push.sh.tmpl`: Captures `REMOTE_NAME` and `CURRENT_BRANCH` and passes as `-- origin main`
   - `pre-reset.sh.tmpl`: Attempts to capture reset context from arguments or environment variables

3. **Browser Template Enhancement**:
   - `templates/guardian/approval.html`: Added collapsible "Command details" section
   - Shows preview in collapsed state (first 50 chars)
   - Displays full command when expanded with proper formatting

### CI/CD Process Hardening

- **Embed Verification**: Added `make verify-embeds` to pre-push quality gates
- **Asset Drift Prevention**: Ensures embedded templates, schemas, and config stay synchronized with source
- **Release Validation**: Strengthens release process with automated embed consistency checks

## Technical Details

### Guardian Command Flow

The enhanced guardian flow now works as follows:

```bash
# User runs git commit
git commit -m "fix: update guardian approval display"

# Pre-commit hook captures the message
COMMIT_MSG_PREVIEW="fix: update guardian approval display"
goneat guardian check git commit --branch main -- -m "$COMMIT_MSG_PREVIEW"

# Guardian displays full command on approval page
# Command details: git commit -m fix: update guardian approval display
```

### Quality Gates

All pre-release quality checks passed:

- ✅ Code formatting and linting
- ✅ Security assessment (0 issues)
- ✅ Embed verification (templates, schemas, config in sync)
- ✅ Build verification across platforms
- ✅ Hook template validation

## Migration Guide

### Upgrading Guardian Hooks

After upgrading to v0.2.11, regenerate your hooks to get the enhanced command visibility:

```bash
goneat hooks generate --with-guardian
goneat hooks install
```

This will update:

- `.git/hooks/pre-commit` - Captures commit messages
- `.git/hooks/pre-push` - Captures push targets
- `.git/hooks/pre-reset` - Captures reset context

No other changes required. All existing guardian policies and configurations remain compatible.

## Files Changed

### Templates

- `templates/hooks/bash/pre-commit.sh.tmpl` - Added commit message capture
- `templates/hooks/bash/pre-push.sh.tmpl` - Added push target capture
- `templates/hooks/bash/pre-reset.sh.tmpl` - Added reset context capture
- `templates/guardian/approval.html` - Added command details display section

### Go Code

- `cmd/guardian.go` - Fixed `runGuardianCheck` and `runGuardianApprove` command construction
- `internal/guardian/browser.go` - Added `FullCommand` field to `ApprovalSession` and template data

### Build System

- Pre-push hook now includes `make verify-embeds` for asset synchronization validation

## Acknowledgments

Special thanks for identifying the guardian UX issue and working through the solution to provide complete command visibility in approval workflows.
