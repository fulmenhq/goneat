# Goneat v0.3.11 — Windows Compatibility & Test Parallelization

**Release Date**: 2025-12-03
**Status**: Release

## TL;DR

- **Windows Platform Support**: goneat is now operational on Windows with proper binary naming, test compatibility, and line ending handling
- **Test Parallelization**: Added `t.Parallel()` to 124 tests across 3 packages with 1.79x speedup measured on Windows
- **SBOM Support**: New syft tool integration for Software Bill of Materials generation
- **Line Ending Standards**: Established `.gitattributes` for consistent cross-platform line endings
- **Critical Fix**: Resolved CRLF file corruption bug in formatter that was breaking Windows formatting

## Breaking Changes

None. All changes are backwards compatible.

## Highlights

### Windows Platform Support (Operational)

goneat now runs successfully on Windows with full operational support:

**Binary Naming**:

- Makefile detects Windows platform and builds `goneat.exe`
- Integration tests properly detect `.exe` extension on Windows
- Test helpers use platform-specific binary naming

**Package Manager Integration**:

- Foundation tools (ripgrep, jq) install via Scoop on Windows
- syft tool supports Scoop installation method
- Package manager detection includes 5-second timeouts to prevent hangs

**Test Compatibility**:

- All integration tests now properly handle Windows binary paths
- Test timeouts added (30 seconds for commands, 15 minutes for full suite)
- Tests properly detect and use platform-specific binary extensions

**Status**: ✅ Operational for running goneat, formatting, and assessment. Full build/dev/deployment workflows still in progress.

### Cross-Platform Line Ending Standard

Added `.gitattributes` to establish repository-wide line ending standards:

**Standards**:

- Text files normalized to LF on commit (all platforms)
- Shell scripts forced to LF (required for Unix/Mac execution)
- Windows-specific files (.bat, .cmd, .ps1) use CRLF
- Binary files properly marked
- Prevents CRLF/LF inconsistencies across development environments

**Impact**:

- Ensures consistent behavior across Windows, Mac, and Linux
- Prevents git showing false file changes due to line ending differences
- Maintains Windows compatibility where needed

### Critical Fix: CRLF File Corruption

**Problem**: The finalizer was corrupting CRLF files on Windows by creating double CR characters (`\r\r\n`).

**Root Cause**:

```go
// Before: strings.Split on CRLF content left CRs attached
lines := strings.Split(content, "\n")  // ["line\r", "line\r"]
result := strings.Join(lines, "\r\n")  // "line\r\r\nline\r\r\n" ❌
```

**Solution**: Normalize to LF before processing, detect original line ending, rejoin with detected ending.

**Impact**: Files with CRLF on Windows were repeatedly detected as needing formatting, causing format instability.

**Result**: Windows formatting now stable and preserves file's original line ending style.

### Test Parallelization Infrastructure

Added parallel test execution support to improve test performance:

**Parallelization Progress**:

- Added `t.Parallel()` to 124 tests across 3 packages:
  - `internal/doctor`: 69 tests
  - `pkg/versioning`: 23 tests
  - `pkg/schema`: 32 tests (3 excluded due to `t.Setenv` incompatibility)
- Represents 14% of total test suite (124/888 tests)

**Performance Improvement**:

- Measured 1.79x speedup (44% faster) with `-parallel 3` on Windows
- Tests properly isolated with `t.TempDir()` for file operations
- All parallelized tests pass race detector validation

**Usage**:

```bash
# Default: serial execution
make test

# Parallel execution
export GONEAT_TEST_PARALLEL=3
make test

# Or inline
make test GONEAT_TEST_PARALLEL=4
```

**Safety Validation**:

- ✅ No shared state or global variables
- ✅ File I/O uses `t.TempDir()` for isolation
- ✅ No environment variable modification
- ✅ Race detector clean
- ❌ Tests using `t.Setenv()` excluded (Go restriction)

**Future Work**: Planning document created at `.plans/active/v0.3.x-plans/test-parallelization-candidates.md` identifying ~400-500 additional tests safe for parallelization (target: 45-56% of suite).

### SBOM Tools Support

Added Software Bill of Materials (SBOM) generation capability via syft:

**Features**:

- New `sbom` scope in tools configuration
- syft tool definition with cross-platform installers:
  - darwin/linux: `brew install syft`
  - windows: `scoop install main/syft`
- Integration with `goneat dependencies --sbom` command
- Included in standard scopes from `goneat doctor tools init`

**Usage**:

```bash
# Install syft
goneat doctor tools --scope sbom --install --yes

# Generate SBOM
goneat dependencies --sbom
```

### Additional Improvements

**Test Infrastructure**:

- Added 30-second timeouts to test helper commands (prevents Windows hangs)
- Package manager detection timeouts (5 seconds)
- Test timeout increased from 10m to 15m for Windows compatibility

**Format Command Error Handling**:

- Fixed "finalized" error being treated as failure
- "finalized" now properly indicates successful file modification
- Eliminates false ERROR logs for finalizer-only changes

## Known Issues

### yamlfmt on Windows

Occasional error with `.git/**` path syntax:

```
CreateFile .git/**: The filename, directory name, or volume label syntax is incorrect.
```

**Impact**: Does not block formatting of other files
**Status**: Under investigation (appears to be yamlfmt issue)

## Upgrade Notes

### For Windows Users

If you've been experiencing formatting instability on Windows (files repeatedly showing as needing formatting):

1. Update to v0.3.11
2. Run `goneat format` once
3. Formatting should now be stable

The CRLF corruption bug is fixed in this release.

### For All Users

The test parallelization is opt-in via the `GONEAT_TEST_PARALLEL` environment variable. Default behavior (serial execution) is unchanged.

## Development Impact

### Test Execution Time

On Windows with `-parallel 3`:

- **Before**: ~2m20s for parallelized test packages
- **After**: ~1m20s for same packages
- **Speedup**: 1.79x (44% faster)

### Cross-Platform Development

With `.gitattributes` in place:

- Line endings normalized automatically on commit
- No more false file changes due to CRLF/LF differences
- Platform-specific files maintain appropriate endings

## Files Changed

**Windows Compatibility**:

- `Makefile`: Platform detection for binary naming
- `tests/integration/testenv.go`: Windows binary detection
- `pkg/format/finalizer/finalizer.go`: CRLF corruption fix
- `.gitattributes`: Line ending standards (new file)

**Test Parallelization**:

- `internal/doctor/*_test.go`: 69 tests parallelized
- `pkg/versioning/versioning_test.go`: 23 tests parallelized
- `pkg/schema/**/*_test.go`: 32 tests parallelized
- `.plans/active/v0.3.x-plans/test-parallelization-candidates.md`: Future work planning

**SBOM Support**:

- `internal/assets/embedded_config/config/tools/foundation-tools-defaults.yaml`: syft tool definition
- Integration with dependencies command

**Documentation**:

- `README.md`: Updated Windows support status
- `CHANGELOG.md`: Full v0.3.11 release notes

## Performance Metrics

| Metric                    | Value           |
| ------------------------- | --------------- |
| Tests Parallelized        | 124 / 888 (14%) |
| Speedup (Windows)         | 1.79x           |
| Packages Parallelized     | 3               |
| Tests Excluded (t.Setenv) | 3               |
| Race Detector             | ✅ Clean        |

## Testing

All changes validated on:

- ✅ macOS (darwin/arm64)
- ✅ Windows (via testing and validation)
- ✅ Linux (CI)

Race detector validation:

```bash
go test ./pkg/versioning/... -race -parallel 4  # ✅ pass
go test ./pkg/schema/... -race -parallel 4       # ✅ pass
go test ./internal/doctor/... -race -parallel 4  # ✅ pass
```

## What's Next

**v0.3.12 Planning** (Test Parallelization Phase 2):

- Target packages: `pkg/config`, `pkg/util`, `pkg/format`
- Goal: 180-220 tests parallelized (20-25% of suite)
- See planning document for details

**Windows Development** (Future):

- Complete build/dev/deployment workflow validation
- CI matrix expansion for Windows testing
- Additional Windows-specific tool integrations

## Full Changelog

See [CHANGELOG.md](../../CHANGELOG.md) for complete details.

---

**Previous Release**: [v0.3.10](v0.3.10.md)
