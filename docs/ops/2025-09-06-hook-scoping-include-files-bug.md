# Bug Report: Hook IncludeFiles Scoping Not Fully Respected

**Bug ID**: `v0.1.5-hook-scoping-include-files`
**Date Reported**: 2025-09-06
**Reporter**: Code Scout
**Supervisor**: @3leapsdave
**Severity**: Medium
**Status**: ✅ RESOLVED (commit 5dcc814)

## Problem Summary

When hooks are configured with staged-only optimization (`optimization.only_changed_files: true`) and an IncludeFiles scope is derived from staged files, some runners still assess files outside the scope. This causes noisy results during hook runs (especially pre-push), surfacing findings from unrelated files and work-in-progress areas.

## Observed Behavior

- Format assessment reports normalization and gofmt issues outside the staged file set.
- Security assessment includes module-wide scans (e.g., govulncheck) and full-repo secrets scans, ignoring IncludeFiles scoping.

## Expected Behavior

- With a non-empty IncludeFiles set (from staged-only or explicit `--include`), all runners should limit discovery and reporting to the scoped file set, or explicitly document and gate exceptions (e.g., dependency vulnerability scans).

## Root Cause Analysis

1. FormatAssessmentRunner.Assess uses work planner discovery and does not filter by `config.IncludeFiles`. The existing `findSupportedFiles` + `shouldIncludeFile` utilities honor IncludeFiles, but the Assess path bypasses them after planner generation.
2. Security tools:
   - gosec: honors IncludeFiles by reducing to unique directories (works as expected).
   - govulncheck: operates at module/package level and currently runs module-wide, ignoring IncludeFiles.
   - gitleaks: scans the repository source path by default; IncludeFiles is not propagated.

## Proposed Resolution

- Format:
  - After planner manifest generation, filter `manifest.WorkItems` by `config.IncludeFiles` before checks; or switch to `findSupportedFiles` which already respects IncludeFiles and ignore patterns.
- Security:
  - gosec: keep current IncludeFiles→dir scoping.
  - govulncheck: when `IncludeFiles` is non-empty, either:
    - restrict to impacted packages derived from IncludeFiles (best), or
    - skip govulncheck in hook mode when scoped (documented behavior), or
    - run module-wide but post-filter findings to files within scope (trade-off: may miss transitive context).
  - gitleaks: when `IncludeFiles` is non-empty, limit `--source` to the minimal common ancestors of IncludeFiles or filter results to scoped files; alternatively, disable secrets scan in pre-commit and keep in pre-push only.

## Resolution & Validation

- Format: Added IncludeFiles scoping in FormatAssessmentRunner to filter discovered files. Validated with `--include` runs; scoped to single file produced 1-issue output.
- Security (gosec): Retained dir-level sharding but added post-filter to IncludeFiles to reduce noise. Validated with `--include` reducing non-matching files to zero.
- Security (govulncheck): When scoped, restricts arguments to impacted package dirs and post-filter via IncludeFiles (go.mod results implicitly excluded); validated by zero findings when out-of-scope.
- Security (gitleaks): Limited source to nearest common ancestor and post-filtered findings by IncludeFiles.

Note: Follow-up tests can be added in CI; manual runs verified scope behavior for format and security categories.

## Notes

- Short-term mitigation: we restored pre-commit to non-staged-only and ensured per-hook category/fail-on parsing works as intended, preventing security scans on pre-commit unless configured.

Generated by Code Scout ([Opencode](https://opencode.ai/)) under supervision of [@3leapsdave](https://github.com/3leapsdave)

Co-Authored-By: Code Scout <noreply@3leaps.net>
Co-Authored-By: Forge Neat <noreply@3leaps.net>
Authored-By: Dave Thompson <dave.thompson@3leaps.net> [@3leapsdave](https://github.com/3leapsdave)
