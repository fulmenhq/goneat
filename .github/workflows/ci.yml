name: CI
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
jobs:
  build-test-lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.x'
      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-
      - name: Build
        run: |
          make build
      - name: Verify embedded assets in sync
        run: |
          make verify-embeds
      - name: Bootstrap tools (dogfooding)
        run: |
          make bootstrap
          # Persist shim paths for subsequent steps (brew bin, go bin, etc.)
          ./dist/goneat doctor tools env --github >> $GITHUB_PATH
      - name: Verify foundation tools accessible (format check)
        run: |
          # Verify tools installed by bootstrap are accessible in PATH
          echo "Verifying foundation tools..."
          which prettier || (echo "prettier not found" && exit 1)
          which yamlfmt || (echo "yamlfmt not found" && exit 1)
          which golangci-lint || (echo "golangci-lint not found" && exit 1)
          echo "All foundation tools accessible"
          # Run format check to validate tools work end-to-end
          ./dist/goneat format --check || echo "Format differences found (informational)"
      - name: Test
        run: |
          make test || true
      - name: Install golangci-lint (v2)
        uses: golangci/golangci-lint-action@v7
        with:
          version: v2.4.0
      - name: Lint (informational for 0.2.1)
        run: |
          golangci-lint run || true
  install-probe:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.x'
      - name: Install probe (foundation tool availability)
        env:
          GONEAT_INSTALL_PROBE: "1"
        run: |
          make install-probe
