---
# yamllint disable rule:truthy
name: CI
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
jobs:
  # =============================================================================
  # JOB 1: Build & Test (no external tools required)
  # =============================================================================
  build-test-lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.x'
          # setup-go@v5 has built-in caching - no explicit cache step needed
      - name: Build
        run: make build
      - name: Verify embedded assets in sync
        run: make verify-embeds
      - name: Test
        run: make test || true
      - name: Install golangci-lint (v2)
        uses: golangci/golangci-lint-action@v7
        with:
          version: v2.4.0
      - name: Lint (informational)
        run: golangci-lint run || true
      - name: Upload goneat binary
        uses: actions/upload-artifact@v4
        with:
          name: goneat-linux
          path: dist/goneat
          retention-days: 1

  # =============================================================================
  # JOB 2: Container Probe (LOW friction - validates container path)
  # Proves: goneat works inside goneat-tools container
  # This is THE recommended approach for CI runners
  # =============================================================================
  container-probe:
    needs: [build-test-lint]
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/fulmenhq/goneat-tools:latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Download goneat binary
        uses: actions/download-artifact@v4
        with:
          name: goneat-linux
          path: ./bin
      - name: Verify container tools (raw)
        run: |
          echo "=== Tools in goneat-tools container ==="
          prettier --version
          yamlfmt --version
          jq --version
          yq --version
          rg --version
          echo "=== All foundation tools present ==="
      - name: Validate goneat integration
        run: |
          chmod +x ./bin/goneat
          echo "=== goneat doctor tools --scope foundation ==="
          ./bin/goneat doctor tools --scope foundation || true
          echo "=== goneat format --check (dry-run) ==="
          ./bin/goneat format --check . || echo "Format diffs (info)"
      - name: Check YAML formatting
        run: yamlfmt -lint . || echo "YAML format diffs (info)"
      - name: Check Markdown/JSON formatting
        run: prettier --check "**/*.{md,json}" || echo "Prettier diffs (info)"

  # =============================================================================
  # JOB 3: Bootstrap Probe (HIGHER friction - validates package manager path)
  # Proves: goneat doctor tools --install works on fresh runners
  # Only runs if container-probe passes (don't waste cycles if container fails)
  # =============================================================================
  bootstrap-probe:
    needs: [container-probe]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.x'
      - name: Bootstrap probe (package manager installation)
        env:
          GONEAT_INSTALL_PROBE: "1"
        run: |
          echo "=== Testing package manager tool installation ==="
          echo "Validates higher-friction path for non-container users"
          make install-probe
