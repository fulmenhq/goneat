#!/bin/bash
# Generated by goneat hooks generate
# Schema-compliant hook template (bash)

set -euo pipefail

# Establish repository root for reliable relative paths
REPO_ROOT=$(git rev-parse --show-toplevel 2>/dev/null || pwd)

# Resolve goneat home for ephemeral artifacts (reports/cache/tmp)
# Repo .goneat/ is static-only; do not write reports here.
GONEAT_HOME="${GONEAT_HOME:-$HOME/.goneat}"
export GONEAT_HOME

# Detect dev mode: enabled if $REPO_ROOT/.goneat/dev-mode exists or env is set
DEV_MODE=0
if [ -f "$REPO_ROOT/.goneat/dev-mode" ] || [ "${GONEAT_DEV_MODE:-0}" = "1" ]; then
  DEV_MODE=1
fi

echo "üîç Running goneat pre-reset guardian check..."

# Robust binary discovery (prefer repo build first, then PATH/common locations)
find_goneat_bin() {
  if [ -x "$REPO_ROOT/dist/goneat" ]; then
    echo "$REPO_ROOT/dist/goneat"
    return 0
  fi
  local candidates=(
    "$HOME/go/bin/goneat"
    "/opt/homebrew/bin/goneat"
    "/usr/local/bin/goneat"
    "$HOME/.local/bin/goneat"
    "$HOME/.goneat/bin/goneat"
    "goneat"
  )
  for c in "${candidates[@]}"; do
    if [ -x "$c" ] || command -v "$c" >/dev/null 2>&1; then
      echo "$c"
      return 0
    fi
  done
  return 1
}

GONEAT_BIN=""
if BIN=$(find_goneat_bin); then
  GONEAT_BIN="$BIN"
fi

if [ -z "$GONEAT_BIN" ]; then
  if [ "$DEV_MODE" = "1" ]; then
    echo "‚ö†Ô∏è  goneat not found (dev mode). Allowing reset without guardian check"
    exit 0
  else
    echo "‚ùå goneat CLI not found. Pre-reset guardian check requires goneat."
    echo "üëâ Install options:"
    echo "   - Go:   go install github.com/fulmenhq/goneat@latest   (ensure \$GOPATH/bin in \$PATH)"
    echo "   - Brew: brew install 3leaps/tap/goneat                (macOS, if tap available)"
    echo "   - Releases: https://github.com/fulmenhq/goneat/releases"
    echo "üîé Searched: $REPO_ROOT/dist, $HOME/go/bin, /opt/homebrew/bin, /usr/local/bin, $HOME/.local/bin, $HOME/.goneat/bin"
    echo "üí° Tip: export PATH=\"$HOME/go/bin:$HOME/.local/bin:$PATH\""
    exit 1
  fi
fi

# Guardian enforcement for protected git reset operations
{{- if .Guardian.Enabled }}
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "")
GUARDIAN_SCOPE="{{ .Guardian.Scope }}"
GUARDIAN_OPERATION="{{ .Guardian.Operation }}"

GUARDIAN_ARGS=("$GONEAT_BIN" guardian check "$GUARDIAN_SCOPE" "$GUARDIAN_OPERATION")
if [ -n "$CURRENT_BRANCH" ]; then
  GUARDIAN_ARGS+=("--branch" "$CURRENT_BRANCH")
fi

# Pass generic reset context for display
GUARDIAN_ARGS+=("--" "<reset arguments>")

if ! "${GUARDIAN_ARGS[@]}"; then
  echo ""
  echo "‚ùå Git reset blocked by guardian"
  echo "üîê Approval required for: ${GUARDIAN_SCOPE} ${GUARDIAN_OPERATION}"
  if [ -n "$CURRENT_BRANCH" ]; then
    echo "   ‚Ä¢ Branch: $CURRENT_BRANCH"
  fi
  {{- if .Guardian.Risk }}
  echo "   ‚Ä¢ Risk level: {{ .Guardian.Risk }}"
  {{- end }}
  {{- if .Guardian.Method }}
  echo "   ‚Ä¢ Method: {{ .Guardian.Method }}"
  {{- end }}
  {{- if .Guardian.Expires }}
  echo "   ‚Ä¢ Approval expires in: {{ .Guardian.Expires }}"
  {{- end }}
  {{- if .Guardian.RequireReason }}
  echo "üìù A reason is required when approving this operation."
  {{- end }}
  echo ""
  echo "Wrap your git reset with guardian approval to continue:"
  echo "  $GONEAT_BIN guardian approve $GUARDIAN_SCOPE $GUARDIAN_OPERATION -- git reset"
  echo "  # add your usual reset arguments after git reset"
  exit 1
fi

echo "‚úÖ Guardian approval satisfied for git reset"
{{- else }}
echo "‚ö†Ô∏è  Guardian not enabled for reset operations"
{{- end }}

echo "‚úÖ Pre-reset check passed!"
