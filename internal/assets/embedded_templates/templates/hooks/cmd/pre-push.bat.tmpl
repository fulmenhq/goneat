@echo off
REM CMD hook template for goneat pre-push validation
REM Generated by goneat hooks generate
REM Schema-compliant hook template (CMD)

setlocal enabledelayedexpansion

REM Resolve repository root for reliable relative paths
for /f "tokens=*" %%i in ('git rev-parse --show-toplevel 2^>nul') do set "REPO_ROOT=%%i"
if errorlevel 1 (
    set "REPO_ROOT=%CD%"
)

REM Resolve goneat home for ephemeral artifacts (reports/cache/tmp)
REM Repo .goneat/ is static-only; do not write reports here.
if defined GONEAT_HOME (
    set "GONEAT_HOME=%GONEAT_HOME%"
) else (
    set "GONEAT_HOME=%USERPROFILE%\.goneat"
)

REM Detect dev mode: enabled if .goneat/dev-mode exists or env is set
set "DEV_MODE=0"
if exist "%REPO_ROOT%\.goneat\dev-mode" set "DEV_MODE=1"
if "%GONEAT_DEV_MODE%"=="1" set "DEV_MODE=1"

echo üöÄ Running goneat pre-push validation...

REM Robust binary discovery (prefer repo build first, then PATH/common locations)
set "GONEAT_BIN="

REM Check repo dist directory
if exist "%REPO_ROOT%\dist\goneat.exe" (
    set "GONEAT_BIN=%REPO_ROOT%\dist\goneat.exe"
    goto :found_binary
)
if exist "%REPO_ROOT%\dist\goneat" (
    set "GONEAT_BIN=%REPO_ROOT%\dist\goneat"
    goto :found_binary
)

REM Check common locations
for %%i in (
    "%GOPATH%\bin\goneat.exe"
    "%GOPATH%\bin\goneat"
    "%USERPROFILE%\go\bin\goneat.exe"
    "%USERPROFILE%\go\bin\goneat"
    "%USERPROFILE%\.local\bin\goneat.exe"
    "%USERPROFILE%\.local\bin\goneat"
    "%USERPROFILE%\.goneat\bin\goneat.exe"
    "%USERPROFILE%\.goneat\bin\goneat"
    "goneat.exe"
    "goneat"
) do (
    if exist "%%~i" (
        set "GONEAT_BIN=%%~i"
        goto :found_binary
    )
    REM Also try where command
    where "%%~i" >nul 2>&1
    if !errorlevel! equ 0 (
        set "GONEAT_BIN=%%~i"
        goto :found_binary
    )
)

:found_binary
if "%GONEAT_BIN%"=="" (
    if "%DEV_MODE%"=="1" (
        echo ‚ö†Ô∏è  goneat not found (dev mode). Using fallback validation
        {{- if .Fallback }}
        {{ .Fallback }}
        {{- else }}
        echo Skipping validation - goneat not available
        {{- end }}
        exit /b 0
    ) else (
        echo ‚ùå goneat CLI not found. Pre-push validation requires goneat.
        echo üëâ Install options:
        echo    - Go:   go install github.com/fulmenhq/goneat@latest
        echo    - Scoop: scoop install goneat
        echo    - Releases: https://github.com/fulmenhq/goneat/releases
        echo üîé Searched: %REPO_ROOT%\dist, %GOPATH%\bin, %USERPROFILE%\go\bin, %USERPROFILE%\.local\bin, %USERPROFILE%\.goneat\bin
        echo üí° Tip: Ensure Go bin directory is in PATH
        exit /b 1
    )
)

REM Guardian enforcement for protected git push operations
{{- if .Guardian.Enabled }}
set "GUARDIAN_SCOPE={{ .Guardian.Scope }}"
set "GUARDIAN_OPERATION={{ .Guardian.Operation }}"
set "CURRENT_BRANCH="
for /f "usebackq tokens=*" %%b in (`git rev-parse --abbrev-ref HEAD 2^>nul`) do set "CURRENT_BRANCH=%%b"

set "REMOTE_NAME=%~1"
set "REMOTE_URL=%~2"

set "GUARDIAN_ARGS=guardian check %GUARDIAN_SCOPE% %GUARDIAN_OPERATION%"
if defined CURRENT_BRANCH set "GUARDIAN_ARGS=%GUARDIAN_ARGS% --branch %CURRENT_BRANCH%"
if defined REMOTE_NAME (
    set "GUARDIAN_ARGS=%GUARDIAN_ARGS% --remote %REMOTE_NAME%"
) else if defined REMOTE_URL (
    set "GUARDIAN_ARGS=%GUARDIAN_ARGS% --remote %REMOTE_URL%"
)

"%GONEAT_BIN%" %GUARDIAN_ARGS%
if errorlevel 1 (
    echo.
    echo ‚ùå Operation blocked by guardian
    echo üîê Approval required for: %GUARDIAN_SCOPE% %GUARDIAN_OPERATION%
    if defined CURRENT_BRANCH echo    ‚Ä¢ Branch: %CURRENT_BRANCH%
    if defined REMOTE_NAME (
        echo    ‚Ä¢ Remote: %REMOTE_NAME%
    ) else if defined REMOTE_URL (
        echo    ‚Ä¢ Remote URL: %REMOTE_URL%
    )
    {{- if .Guardian.Risk }}echo    ‚Ä¢ Risk level: {{ .Guardian.Risk }}{{- end }}
    {{- if .Guardian.Method }}echo    ‚Ä¢ Method: {{ .Guardian.Method }}{{- end }}
    {{- if .Guardian.Expires }}echo    ‚Ä¢ Approval expires in: {{ .Guardian.Expires }}{{- end }}
    {{- if .Guardian.RequireReason }}echo üìù A reason is required when approving this operation.{{- end }}
    echo.
    echo Choose an approval path:
    if defined REMOTE_NAME (
        echo   %GONEAT_BIN% guardian approve %GUARDIAN_SCOPE% %GUARDIAN_OPERATION% --remote %REMOTE_NAME%
    ) else if defined REMOTE_URL (
        echo   %GONEAT_BIN% guardian approve %GUARDIAN_SCOPE% %GUARDIAN_OPERATION% --remote %REMOTE_URL%
    ) else (
        echo   %GONEAT_BIN% guardian approve %GUARDIAN_SCOPE% %GUARDIAN_OPERATION%
    )
    echo   %GONEAT_BIN% guardian grant %GUARDIAN_SCOPE% %GUARDIAN_OPERATION%
    exit /b 1
)

echo ‚úÖ Guardian approval satisfied
{{- end }}

REM Use goneat's orchestrated assessment (manifest-driven)
set "ARGS=assess --hook pre-push --hook-manifest "%REPO_ROOT%\.goneat\hooks.yaml""

{{- if or .OptimizationSettings.OnlyChangedFiles (eq .OptimizationSettings.ContentSource "index") }}
set "ARGS=%ARGS% --staged-only"
{{- end }}

{{- range .Args }}
set "ARGS=%ARGS% {{ . }}"
{{- end }}

"%GONEAT_BIN%" %ARGS%

if errorlevel 1 (
    exit /b %errorlevel%
)

echo ‚úÖ Pre-push validation passed!
exit /b 0
