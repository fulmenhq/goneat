package dependencies

import (
	"testing"
	"time"

	"github.com/fulmenhq/goneat/pkg/vulnerabilities"
)

func TestRemediationAgeUsesPublishedDate(t *testing.T) {
	policy := &VulnerabilityPolicy{
		Enabled:        true,
		FailOn:         "high",
		RemediationAge: map[string]int{"high": 30},
	}

	findings := []vulnerabilities.Finding{
		{
			ID:            "CVE-TEST-1",
			Severity:      vulnerabilities.SeverityHigh,
			PublishedDate: time.Now().Format("2006-01-02"),
		},
	}

	summary := vulnerabilities.Summary{Counts: map[vulnerabilities.Severity]int{vulnerabilities.SeverityHigh: 1}}
	issues := evaluateVulnerabilityPolicy(policy, &findings, &summary)

	if len(issues) != 0 {
		t.Fatalf("expected no issues due to remediation_age suppression, got %d", len(issues))
	}
	if summary.Suppressed != 1 {
		t.Fatalf("expected 1 suppressed finding, got %d", summary.Suppressed)
	}
	if findings[0].SuppressReason == "" {
		t.Fatalf("expected suppress reason to be set")
	}
}

func TestRemediationAgeFallsBackToFixFirstSeen(t *testing.T) {
	policy := &VulnerabilityPolicy{
		Enabled:        true,
		FailOn:         "high",
		RemediationAge: map[string]int{"high": 30},
	}

	findings := []vulnerabilities.Finding{
		{
			ID:           "CVE-TEST-2",
			Severity:     vulnerabilities.SeverityHigh,
			FixFirstSeen: time.Now().Format("2006-01-02"),
		},
	}

	summary := vulnerabilities.Summary{Counts: map[vulnerabilities.Severity]int{vulnerabilities.SeverityHigh: 1}}
	issues := evaluateVulnerabilityPolicy(policy, &findings, &summary)

	if len(issues) != 0 {
		t.Fatalf("expected no issues due to remediation_age suppression, got %d", len(issues))
	}
	if summary.Suppressed != 1 {
		t.Fatalf("expected 1 suppressed finding, got %d", summary.Suppressed)
	}
}
